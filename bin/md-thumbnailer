#!/bin/sh
# ---------------------------------------------------
# Thumbnailer for Ms Office documents
#
# Procedure :
#   http://bernaerts.dyndns.org/linux/76-gnome/325-gnome-shell-generate-msoffice-thumbnail-nautilus
# Depends on :
#   * unoconv
#   * gvfs-copy (gvfs-bin package)
#   * convert and composite (imagemagick package)
# Parameters :
#   $1 - URI of office file
#   $2 - full path of generated thumbnail
#   $3 - height of thumbnail in pixels
# Revision history :
# 11/11/2014, V1.0 - Creation by N. Bernaerts
# 15/11/2014, V2.0 - Change to URI and GVFS to handle thumbnails on network shares
# 31/07/2015, V2.1 - More robust unoconv command line (thanks to Vaderqk)
# ---------------------------------------------------

# check tools availability
command -v gvfs-copy >/dev/null 2>&1 || exit 1
command -v pandoc >/dev/null 2>&1 || exit 1
command -v html2ps >/dev/null 2>&1 || exit 1
command -v convert >/dev/null 2>&1 || exit 1
command -v composite >/dev/null 2>&1 || exit 1

# path where to get icons used for generation
ICONPATH="/opt/extras.ubuntu.com/utext/share/utext/pixmaps"

# get parameters
FILE_URI=$1
FILE_THUMB=$2
HEIGHT=$3

# get filename extension
FILE_EXT=$(echo "$FILE_URI" | sed 's/^.*\.\(.*\)/\1/')

# generate temporary directory
TMP_DIR=$(mktemp -d)
TMP_BASEFILE="$TMP_DIR/file"

# copy file to temporary local directory
gvfs-copy "${FILE_URI}" "${TMP_BASEFILE}.${FILE_EXT}"

# get the file mime type (application/msword, ...)
MIMETYPE=$(mimetype -b "${TMP_BASEFILE}.${FILE_EXT}")

# determine icon type according to mime type
case $MIMETYPE in 
	"text/x-markdown")
		pandoc "${TMP_BASEFILE}.${FILE_EXT}" > "${TMP_BASEFILE}.html"
		html2ps "${TMP_BASEFILE}.html" > "${TMP_BASEFILE}.ps"
		convert "${TMP_BASEFILE}.ps[0]"  "${TMP_BASEFILE}.png"
		composite -gravity center \( -resize x244 "${TMP_BASEFILE}.png" \) ${ICONPATH}/markdown.png ${ICONPATH}/markdown-mask.png \( -resize x${HEIGHT} \) "$FILE_THUMB"
		;;
  * )
esac

# remove temporary files
#rm -R $TMP_DIR
